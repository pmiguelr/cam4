function translatorAddMessage(message){$("#warning-overlay").hide(),_messages.model.add(message)}function translatorRemoveMessage(messageKey){_messages.model.remove(messageKey)}function _displayGeneralNotification(notifData){_messages.model.messagesList.push({userType:function(){return notifData.userType},content:function(){return notifData.content},tab:function(){return notifData.tab},detectedLanguage:function(){return notifData.detectedLanguage},ignored:function(){return notifData.ignored},roomModerator:function(){return notifData.roomModerator},id:function(){return notifData.id},lower_username:function(){return notifData.lower_username},hash:function(){return notifData.hash},messageKey:function(){return notifData.messageKey}}),m.redraw()}function displayTippingCultureNotification(content){var id=content?"gameEnabledNotification":"tippingCulture";_displayGeneralNotification({userType:id,content:content||'<div id="tippingCulture"><img src="'+WEB_CDN+'/images/tokens120.png""><span class="title">'+js_i18n.tippingCultureTitle+'</span><span class="description">'+js_i18n.tippingCultureText+"</span><span>"+js_i18n.tippingCultureTextMobile+'</span><span><a class="nopop" onclick="TipFactory.popTokens();">'+nstiplang.buyTokens+"</a></span></div>",tab:"chat",detectedLanguage:Cam4User.lang,ignored:!PageStatus.has("online_viewer"),roomModerator:!1,id:id,lower_username:"",hash:"",messageKey:""})}var _messages={},useFirebaseTranslator=!0,translatorUrl=translatorServer+"/v1/translate",defaulFanBadge=WEB_CDN+"/images/fanclub/badges/icon_fanclub_default.png",AUTO_SUGGEST_MINIMUM_MESSAGES=3,AUTO_SUGGEST_PERCENTAGE=60;_messages.messageTemplate=function(data){this.id=m.prop(),this.content=m.prop(data.msg),this.processedContent=m.prop(ChatUIController.toEmoticon(data.msg)),this.user=m.prop(data.user),this.userType=m.prop(data.userType),this.roomModerator=m.prop(data.roomModerator),this.image=m.prop(data.imageURL),this.tab=m.prop(data.tab),this.lower_username=m.prop(data.lower_username),this.translation=m.prop(data.msg),this.badgeUrl=m.prop(data.badgeUrl||""),this.messageKey=m.prop(data.messageKey||""),this.ignored=m.prop(!1),this.banned=m.prop(!1),this.isBroadcasting=m.prop(data.isBroadcasting),this.detectedLanguage=m.prop(null),this.hash=m.prop(data.hash||null),this.viewerType=m.prop(data.viewerType||0),this.rollthedice=m.prop(data.rollthedice||!1),this.hasTokens=m.prop(data.hasTokens),this.isFanclubSubscribed=m.prop(data.isFanclubSubscribed)},_messages.cache={storage:{},get:function(key){return!!_messages.cache.has(key)&&_messages.cache.storage[key]},set:function(key,value){_messages.cache.storage[key]=value},has:function(key){return key in _messages.cache.storage},remove:function(key){key in _messages.cache.storage&&delete _messages.cache.storage[key]}},_messages.model={messagesList:[],useTranslator:m.prop(!0),showOriginalMessage:m.prop(!1),activeLanguage:m.prop(Cam4User.lang),userLanguage:Cam4User.lang,showTranslation:m.prop(!1),translationBarVisible:m.prop(!1),detectionOnce:m.prop(!1),translationsQuota:m.prop(Cam4User.maxTranslatedMessages),overQuotaTriggered:m.prop(!1),translatedMessages:m.prop(0),availableTabs:m.prop([]),setLanguage:function(lang){this.activeLanguage(lang),this.translateAll()},setViewOriginalMessage:function(value){this.showOriginalMessage(value),m.redraw()},toggleTranslations:function(){var currentValue=this.showTranslation();this.showTranslation(!currentValue),m.redraw()},ignoredTypes:["tippingCulture","roomNotification","gameEnabledNotification","gameUpdatedNotification","gameEndedNotification","idVerification"],checkRestriction:function(message){return!(message.lower_username()==Cam4User.userName.toLowerCase()||-1!=_messages.model.ignoredTypes.indexOf(message.userType())||Cam4User.accessLevel<AccessLevel.GOLD&&!Cam4User.isBroadcastingWindow||!TranslationLanguages.hasOwnProperty(_messages.model.activeLanguage()))},add:function(data){var index=this.addWithoutRedraw(data),overQuota=!1;Cam4User.isLoggedIn||(overQuota=this.translatedMessages()>this.translationsQuota());var availableTabs=this.availableTabs();return-1===availableTabs.indexOf(data.tab)&&availableTabs.push(data.tab),!0===this.useTranslator()&&!overQuota&&this.checkRestriction(this.messagesList[index])?this.translate(this.messagesList[index]):m.redraw(),Cam4User.isLoggedIn||!overQuota||this.overQuotaTriggered()||(this.overQuotaTriggered(!0),ChatUI.element.translatorButton.remove(),Utils.decideOffer(),$("#offerToTranslateMain").html("").append($("<a></a>",{class:"nopop",href:"#"}).text(translatorI18n.quotaExceeded).on("click",function(event){Utils.decideOffer(),event.preventDefault()})).removeAttr("id").removeAttr("style").addClass("show")),index},remove:function(messageKey){var messages=_messages.model.messagesList;messages.some(function(message,index){if(message.messageKey()==messageKey)return _messages.cache.remove([_messages.model.activeLanguage(),message.messageKey()].join(".")),messages.splice(index,1)}),m.redraw()},removePrivateMessages:function(){for(var msgList=_messages.model.messagesList,i=msgList.length-1;i>=0;i--)"chat"!==msgList[i].tab()&&"GS"!==msgList[i].tab()&&msgList.splice(i,1)},addWithoutRedraw:function(data){var index=this.messagesList.push(new _messages.messageTemplate(data))-1;return this.messagesList[index].id(index),index},ignoreAndRedraw:function(username){Chat.ignoreUser(username);for(var msgList=_messages.model.messagesList,i=msgList.length-1;i>=0;i--)"chat"==msgList[i].tab()&&msgList[i].lower_username()==username&&this.messagesList[i].ignored(!0);m.redraw()},translate:function(message){var key=[this.activeLanguage(),message.messageKey()].join(".");if(_messages.cache.has(key)){var messageFromCache=_messages.cache.get(key);message.translation(messageFromCache.translatedText),message.detectedLanguage(messageFromCache.detectedSourceLanguage),m.redraw()}else m.request({method:"GET",url:translatorUrl,initialValue:message.content(),data:{target:this.activeLanguage(),token:message.hash(),q:message.content()},deserialize:function(value){return value}}).then(function(response){try{response=JSON.parse(response)}catch(e){response={translatedText:message.content(),detectedSourceLanguage:"unknown"}}_messages.model.showTranslation()&&_messages.model.translatedMessages(_messages.model.translatedMessages()+1),response.translatedText=ChatUIController.toEmoticon(response.translatedText),message.translation(response.translatedText.trim()),message.detectedLanguage(response.detectedSourceLanguage),_messages.cache.set(key,response)})},translateAll:function(){Cam4User.accessLevel<AccessLevel.GOLD||this.messagesList.map(function(message,index){message.id(index),_messages.model.checkRestriction(message)&&_messages.model.translate(message)})}},_messages.controller=function(){m.prop(!1);return{showOriginalMessage:_messages.model.showOriginalMessage,showTranslation:_messages.model.showTranslation,messages:_messages.model.messagesList,toggleTranslatorBar:function(){for(var foreignLanguage,availableTabs=_messages.model.availableTabs(),i=0,showTranslatorFlag=!1;i<availableTabs.length&&!showTranslatorFlag;){foreignLanguage=0;var tabMessages=this.messages.filter(function(message){if(message.tab()==availableTabs[i])return message});i++,tabMessages.map(function(message){null!==message.detectedLanguage()&&message.detectedLanguage()!==_messages.model.userLanguage&&foreignLanguage++}),showTranslatorFlag=(2!=foreignLanguage||tabMessages.length!==AUTO_SUGGEST_MINIMUM_MESSAGES)&&(tabMessages.length>=AUTO_SUGGEST_MINIMUM_MESSAGES&&foreignLanguage/tabMessages.length*100>AUTO_SUGGEST_PERCENTAGE)}return showTranslatorFlag},translationBarVisible:_messages.model.translationBarVisible,toggleTranslatorButton:function(){!0===_messages.model.showTranslation()&&ChatUI.element.translatorButton.removeClass("disabled")},detectionOnce:_messages.model.detectionOnce,scrollToBottomOf:function(wrapper){wrapper.scrollTop=wrapper.scrollHeight}}},_messages.view=function(ctrl,args){function translationView(message){return message.lower_username()==Cam4User.userName.toLowerCase()||message.content().trim()===message.translation().trim()||message.processedContent().trim()===message.translation().trim()?m("p",{},m("span",{},m.trust(message.processedContent()))):ctrl.showOriginalMessage()?m("p",{},m("span",{class:"originalMessage"},m.trust(message.processedContent())),m("span",{class:"translatedMessage"},m.trust(message.translation()))):m("p",{},ctrl.showTranslation()?m.trust(message.translation()):m.trust(message.processedContent()))}function roomNotificationView(message){return!isMobile&&ControlledFeatures.TIPPING_GAME_NOTIFICATIONS?m("div",{class:"chat clearfix generalNotification notificationsActive"+(_.isFunction(message.rollthedice)&&message.rollthedice()?" rollthedice-message":"")},m.trust(message.content())):m("div",{class:"chat clearfix generalNotification"+(_.isFunction(message.rollthedice)&&message.rollthedice()?" rollthedice-message":"")},m.trust(message.content()))}function idVerificationView(message){return m("div",{class:"chat clearfix idVerification"},m.trust(message.content()))}var messageTab=args.tab||"chat",isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobi/i.test(navigator.userAgent),wrapper=args.wrapper;!ctrl.detectionOnce()&&ctrl.toggleTranslatorBar()&&(ctrl.detectionOnce(!0),PlayerTranslate.initAskState()),ctrl.toggleTranslatorButton();var tabMessages=ctrl.messages.filter(function(message){if(message.tab()==messageTab)return message});return tabMessages.length>Cam4User.chatMessagesLimit&&tabMessages.splice(-tabMessages.length,tabMessages.length-Cam4User.chatMessagesLimit),[tabMessages.map(function(message){if(!message.banned||!message.banned()){if("roomNotification"==message.userType())return roomNotificationView(message);if("idVerification"==message.userType())return idVerificationView(message);if(-1!=_messages.model.ignoredTypes.indexOf(message.userType())&&!message.ignored())return!isMobile&&ControlledFeatures.TIPPING_GAME_NOTIFICATIONS?m("div",{class:"chat clearfix generalNotification notificationsActive",id:message.userType()},m.trust(message.content())):m("div",{class:"chat clearfix generalNotification",id:message.userType()},m.trust(message.content()));if(!message.ignored())return m("div",{class:"chat clearfix detected-"+(message.detectedLanguage()?message.detectedLanguage():"un")+" "+message.userType()+(1==message.roomModerator()&&"admin"!=message.userType()&&"moderator"!=message.userType()?" roomModerator":""),"data-username":"admin"==message.userType()||"moderator"==message.userType()?"admin":message.lower_username(),"data-messagekey":message.messageKey()},m("div",{class:"chatAvatar",config:function(){ctrl.scrollToBottomOf(wrapper)}},m("img",{width:40,src:message.image()})),m("div",{class:"messageLine"},""!==message.badgeUrl()?m("img",{class:"badge",src:ControlledFeatures&&ControlledFeatures.FAN_CLUB_IN_PERFORMER_DASHBOARD?defaulFanBadge:message.badgeUrl()}):"",m("p",{class:"nickName"},-1==["admin","roomModerator","moderator","coach","broadcaster","verifiedRoomModerator"].indexOf(message.userType())&&"MBA"!=Cam4User.broadcastSource?m("a",{target:"_blank",href:"/"+message.lower_username()},message.user()):m("span","",message.user()),m("span",{class:"tipLeaderIcon tipLeaderIcon_"+message.user().toLocaleLowerCase(),style:message.user().toLocaleLowerCase()==Cam4User.tipLeader.toLocaleLowerCase()?"display: inline-block":""}),Cam4User.isBroadcaster()&&message.hasTokens()&&"basic"==message.userType()&&!message.isFanclubSubscribed()?m("span",{class:"chat-msg-has-tokens"}):"",Chat.userIsBroadcasting(message.lower_username())&&"broadcaster"!=message.userType()||!1===Cam4User.isLoggedIn&&Chat.userIsBroadcastingNew(message.lower_username())?m("div",{class:"glyphicon glyphicon-facetime-video broadcasting"}):"",message.viewerType()==FirebaseStructure.ViewerType.VR?m("img",{src:WEB_CDN+"/images/chat/vr-icon.png",class:"vrIcon"}):"","verifiedRoomModerator"===message.userType()?m("img",{src:WEB_CDN+"/images/chat/h6.jpg",class:"verifiedRoomModeratorIcon"}):""),"MBA"==Cam4User.broadcastSource||Cam4User.userName.toLowerCase()==message.lower_username()||-1!=["admin","moderator","coach"].indexOf(message.userType())?"":m("div",{class:"chatOptions contextualMenu","data-user":message.user()},m("span",{class:"glyphicon glyphicon-option-vertical"})),ControlledFeatures&&ControlledFeatures.USER_NOTES?m("div",{"data-user":message.user(),class:"userHasNotes editNote "+ChatUIController.checkUserNotes(message.lower_username())+" glyphicon glyphicon-duplicate"}):"",translationView(message)))}})]},Cam4Event.hasEventListener(TipEvent.DICE_GAME_ENABLED,"displayGameEnabledNotification")||Cam4Event.addEventListener(TipEvent.DICE_GAME_ENABLED,function(){TippingGamesUtils.isGameActive()&&_displayGeneralNotification({userType:"gameEnabledNotification",content:TippingGamesUtils.buildNotificationHTML("enabled"),tab:"chat",detectedLanguage:Cam4User.lang,ignored:!1,roomModerator:!1,id:"gameEnabledNotification",lower_username:"",hash:"",messageKey:""})},"displayGameEnabledNotification"),Cam4Event.hasEventListener(TipEvent.DICE_GAME_UPDATED,"displayGameUpdatedNotification")||Cam4Event.addEventListener(TipEvent.DICE_GAME_UPDATED,function(updatedSettings){TippingGamesUtils.isGameActive()&&_displayGeneralNotification({userType:"gameUpdatedNotification",content:TippingGamesUtils.buildNotificationHTML("updated",updatedSettings),tab:"chat",detectedLanguage:Cam4User.lang,ignored:!1,roomModerator:!1,id:"gameUpdatedNotification",lower_username:"",hash:"",messageKey:""})},"displayGameUpdatedNotification"),Cam4Event.hasEventListener(TipEvent.DICE_GAME_ENDED,"displayGameEndedNotification")||Cam4Event.addEventListener(TipEvent.DICE_GAME_ENDED,function(){_displayGeneralNotification({userType:"gameEndedNotification",content:TippingGamesUtils.buildNotificationHTML("ended"),tab:"chat",detectedLanguage:Cam4User.lang,ignored:!1,roomModerator:!1,id:"gameEndedNotification",lower_username:"",hash:"",messageKey:""})},"displayGameEndedNotification"),"undefined"!=typeof module&&module.exports&&(module.exports=_messages);var chatWrapper=document.getElementById("chatTabPanel"),GSWrapper=document.getElementById("GSTabPanel"),GamesWrapper=document.getElementById("GamesTabPanel");chatWrapper&&m.mount(chatWrapper,m.component(_messages,{tab:"chat",wrapper:chatWrapper})),GSWrapper&&m.mount(GSWrapper,m.component(_messages,{tab:"GS",wrapper:GSWrapper})),GamesWrapper&&m.mount(GamesWrapper,m.component(_messages,{tab:"games",wrapper:GamesWrapper})),JsSender.setTranslationSettings=function(options){options=JSON.parse(options);var translationBarVisible=_messages.model.translationBarVisible;options.showBar&&(translationBarVisible()||PlayerTranslate.showOptions()),translationBarVisible(options.showBar),options.enableTranslation?ChatUI.element.translatorButton.removeClass("disabled").addClass("active"):ChatUI.element.translatorButton.removeClass("active").addClass("disabled"),options.enableTranslation||options.ask||options.showBar||ChatUI.element.translatorButton.removeClass("disabled"),PlayerTranslate.setState(options.ask,options.language,options.showBar,!0,options.showOriginalMessage),_messages.model.setLanguage(PlayerTranslate.selectedLanguage),_messages.model.setViewOriginalMessage(!!options.showOriginalMessage),_messages.model.showTranslation(options.enableTranslation)},$j(function(){Cam4User.isLoggedIn&&(Cam4User.isPayingMember()||Cam4User.isBroadcastingWindow)&&PlayerTranslate.getUserSettings();var translationBar=$("#offerToTranslateMain");ChatUI.element.translatorButton.on("click",function(event){!$(this).hasClass("disabled")||translationBar.is(":visible")?((!$(this).hasClass("disabled")&&!$(this).hasClass("active")||$(this).hasClass("active")&&!translationBar.is(":visible")&&!_messages.model.showTranslation())&&(_messages.model.detectionOnce(!0),PlayerTranslate.selectedLanguage&&!PlayerTranslate.active?(PlayerTranslate.showOptions(),PlayerTranslate.updateState(),PlayerTranslate.saveTranslationSettings()):PlayerTranslate.initAskState()),$(this).hasClass("active")&&(translationBar.is(":visible")?(PlayerTranslate.dismissTranslation(),PlayerTranslate.getUserSettings()):PlayerTranslate.showOptions()),event.preventDefault()):PlayerTranslate.showOptions()}),$("#offToTransHref").on("click",function(event){ChatUI.element.translatorButton.addClass("disabled")})});var TippingCultureNotification={showDefault:displayTippingCultureNotification,setContent:displayTippingCultureNotification};ControlledFeatures.USE_GAME_CENTER||TippingCultureNotification.showDefault();